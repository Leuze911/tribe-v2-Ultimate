# TRIBE v2 - E2E Test: Chat IA
# Tests sending messages to Claude and session management
# Prerequisites: User must be logged in

appId: host.exp.Exponent
---

# Test: Send a message and receive response
- launchApp

# Ensure we're on the map screen
- assertVisible:
    text: "Rechercher un lieu..."
    timeout: 5000

# Navigate to chat via menu
- tapOn:
    id: "menu-button"

- tapOn: "Chat IA"

# Wait for chat screen
- assertVisible:
    text: "Assistant TRIBE"
    timeout: 3000

# Verify welcome message
- assertVisible:
    text: "Bonjour"
    timeout: 2000

# Verify suggested questions are visible
- assertVisible: "Comment ajouter un POI ?"

# Test: Tap suggested question
- tapOn: "Comment ajouter un POI ?"

# Verify input is populated
- assertVisible:
    id: "chat-input"

# Clear and type custom message
- tapOn:
    id: "chat-input"
- clearText
- inputText: "Comment gagner des points ?"

# Send message
- tapOn:
    id: "send-button"

# Wait for loading indicator
- assertVisible:
    text: "RÃ©flexion en cours..."
    timeout: 3000
    optional: true

# Wait for response (allow time for API call or demo response)
- waitForAnimationToEnd:
    timeout: 15000

# Verify a response was received (check for common words in demo response)
- assertVisible:
    text: "points"
    timeout: 5000

# Go back to map
- tapOn:
    id: "back-button"

- assertVisible: "Rechercher un lieu..."

---
# Test: Start new chat session
- launchApp

- assertVisible: "Rechercher un lieu..."

- tapOn:
    id: "menu-button"

- tapOn: "Chat IA"

- assertVisible: "Assistant TRIBE"

# Send a message to create a session
- tapOn:
    id: "chat-input"
- inputText: "Bonjour"

- tapOn:
    id: "send-button"

- waitForAnimationToEnd:
    timeout: 10000

# Start new chat
- tapOn:
    id: "new-chat-button"

# Should see welcome message again (new session)
- assertVisible:
    text: "Bonjour ! Je suis l'assistant TRIBE"
    timeout: 2000

---
# Test: View chat history
- launchApp

- assertVisible: "Rechercher un lieu..."

- tapOn:
    id: "menu-button"

- tapOn: "Chat IA"

- assertVisible: "Assistant TRIBE"

# Open history modal
- tapOn:
    id: "history-button"

# Should see history modal
- assertVisible:
    text: "Historique des conversations"
    timeout: 2000

# Close modal
- tapOn:
    text: "close"
    optional: true

# Alternative: tap outside to close
- back
